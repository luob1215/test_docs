"use strict";(self.webpackChunkdeno_docs=self.webpackChunkdeno_docs||[]).push([[9065],{3905:(e,t,n)=>{n.d(t,{Zo:()=>h,kt:()=>m});var r=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},s=Object.keys(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=r.createContext({}),c=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},h=function(e){var t=c(e.components);return r.createElement(l.Provider,{value:t},e.children)},u="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,s=e.originalType,l=e.parentName,h=o(e,["components","mdxType","originalType","parentName"]),u=c(n),d=a,m=u["".concat(l,".").concat(d)]||u[d]||p[d]||s;return n?r.createElement(m,i(i({ref:t},h),{},{components:n})):r.createElement(m,i({ref:t},h))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var s=n.length,i=new Array(s);i[0]=d;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o[u]="string"==typeof e?e:a,i[1]=o;for(var c=2;c<s;c++)i[c]=n[c];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},52218:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>p,frontMatter:()=>s,metadata:()=>o,toc:()=>c});var r=n(87462),a=(n(67294),n(3905));const s={},i="How to Use Redis with Deno",o={unversionedId:"manual/node/how_to_with_npm/redis",id:"manual/node/how_to_with_npm/redis",title:"How to Use Redis with Deno",description:"Redis is an in-memory data store you can use for caching,",source:"@site/runtime/manual/node/how_to_with_npm/redis.md",sourceDirName:"manual/node/how_to_with_npm",slug:"/manual/node/how_to_with_npm/redis",permalink:"/runtime/manual/node/how_to_with_npm/redis",draft:!1,tags:[],version:"current",frontMatter:{}},l={},c=[{value:"Connecting to a Redis client",id:"connecting-to-a-redis-client",level:2},{value:"Setting up the server",id:"setting-up-the-server",level:2},{value:"Checking the cache",id:"checking-the-cache",level:2}],h={toc:c},u="wrapper";function p(e){let{components:t,...s}=e;return(0,a.kt)(u,(0,r.Z)({},h,s,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"how-to-use-redis-with-deno"},"How to Use Redis with Deno"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://redis.io/"},"Redis")," is an in-memory data store you can use for caching,\nas a message broker, or for streaming data."),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://github.com/denoland/examples/tree/main/with-redis"},"View source here.")),(0,a.kt)("p",null,"Here we're going to set up Redis to cache data from an API call to speed up any\nsubsequent requests for that data. We're going to:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Set up a Redis client to save data from every API call in memory"),(0,a.kt)("li",{parentName:"ul"},"Set up a Deno server so we can easily request certain data"),(0,a.kt)("li",{parentName:"ul"},"Call the Github API within the server handler to get the data on first request"),(0,a.kt)("li",{parentName:"ul"},"Serve data from Redis on every subsequent request")),(0,a.kt)("p",null,"We can do this within a single file, ",(0,a.kt)("inlineCode",{parentName:"p"},"main.ts"),"."),(0,a.kt)("h2",{id:"connecting-to-a-redis-client"},"Connecting to a Redis client"),(0,a.kt)("p",null,"We need two modules. The first is the Deno server. We'll use this to get the\ninformation from the user to query our API. The second is Redis. We can grab the\nnode package for Redis using the ",(0,a.kt)("inlineCode",{parentName:"p"},"npm:")," modifier:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx,",metastring:"ignore",ignore:!0},'import { Server } from "https://deno.land/std@0.208.0/http/server.ts";\nimport { createClient } from "npm:redis@^4.5";\n')),(0,a.kt)("p",null,"We create a Redis client using ",(0,a.kt)("inlineCode",{parentName:"p"},"createClient")," and connect to our local Redis\nserver:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx,",metastring:"ignore",ignore:!0},'// make a connection to the local instance of redis\nconst client = createClient({\n  url: "redis://localhost:6379",\n});\n\nawait client.connect();\n')),(0,a.kt)("p",null,"You can also set host, user, password, and port individually in this\n",(0,a.kt)("a",{parentName:"p",href:"https://github.com/redis/node-redis/blob/master/docs/client-configuration.md"},"configuration"),"\nobject."),(0,a.kt)("h2",{id:"setting-up-the-server"},"Setting up the server"),(0,a.kt)("p",null,"Our server is going to act as a wrapper around the Github API. A client can call\nour server with a Github username in the URL pathname, such as\n",(0,a.kt)("inlineCode",{parentName:"p"},"http://localhost:3000/{username}"),"."),(0,a.kt)("p",null,"Parsing out the pathname and calling the Github API will take place inside a\nhandler function in our server. We strip the leading slash so we are left with a\nvariable we can pass to the Github API as a username. We'll then pass the\nresponse back to the user."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx,",metastring:"ignore",ignore:!0},'const server = new Server({\n  handler: async (req) => {\n    const { pathname } = new URL(req.url);\n    // strip the leading slash\n    const username = pathname.substring(1);\n    const resp = await fetch(`https://api.github.com/users/${username}`);\n    const user = await resp.json();\n    return new Response(JSON.stringify(user), {\n        headers: {\n          "content-type": "application/json",\n        },\n      });\n    }\n  },\n\n  port: 3000,\n});\n\nserver.listenAndServe();\n')),(0,a.kt)("p",null,"We'll run this with:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx,",metastring:"ignore",ignore:!0},"deno run --allow-net main.ts\n")),(0,a.kt)("p",null,"If we then go to ",(0,a.kt)("a",{parentName:"p",href:"http://localhost:3000/ry"},"http://localhost:3000/ry")," in\nPostman, we'll get the Github response:"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"uncached-redis-body.png",src:n(11874).Z,width:"1754",height:"1236"})),(0,a.kt)("p",null,"Let's cache this response using Redis."),(0,a.kt)("h2",{id:"checking-the-cache"},"Checking the cache"),(0,a.kt)("p",null,"Once we have our response from the Github API, we can cache this within Redis\nusing ",(0,a.kt)("inlineCode",{parentName:"p"},"client.set"),", with our username as the key and the user object as the\nvalue:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx,",metastring:"ignore",ignore:!0},"await client.set(username, JSON.stringify(user));\n")),(0,a.kt)("p",null,"Next time we request the same username, we can use ",(0,a.kt)("inlineCode",{parentName:"p"},"client.get")," to get the\ncached user:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx,",metastring:"ignore",ignore:!0},"const cached_user = await client.get(username);\n")),(0,a.kt)("p",null,"This returns null if the key doesn't exist. So we can use it in some flow\ncontrol. When we get the username, we'll initially check whether we already have\nthat user in the cache. If we do we'll serve the cached result. If not, we'll\ncall the Github API to get the user, cache it, the serve the API result. In both\ncases, we'll add a custom header to show which version we're serving:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx,",metastring:"ignore",ignore:!0},'const server = new Server({\n  handler: async (req) => {\n    const { pathname } = new URL(req.url);\n    // strip the leading slash\n    const username = pathname.substring(1);\n    const cached_user = await client.get(username);\n    if (cached_user) {\n      return new Response(cached_user, {\n        headers: {\n          "content-type": "application/json",\n          "is-cached": "true",\n        },\n      });\n    } else {\n      const resp = await fetch(`https://api.github.com/users/${username}`);\n      const user = await resp.json();\n      await client.set(username, JSON.stringify(user));\n      return new Response(JSON.stringify(user), {\n        headers: {\n          "content-type": "application/json",\n          "is-cached": "false",\n        },\n      });\n    }\n  },\n\n  port: 3000,\n});\n\nserver.listenAndServe();\n')),(0,a.kt)("p",null,"Running this first time gives us the same response as above, and we'll see the\n",(0,a.kt)("inlineCode",{parentName:"p"},"is-cached")," header set to ",(0,a.kt)("inlineCode",{parentName:"p"},"false"),":"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"uncached-redis-header.png",src:n(93274).Z,width:"1746",height:"872"})),(0,a.kt)("p",null,"But call with the same username again, and we get the cached result. The body is\nidentical:"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"cached-redis-body.png",src:n(28504).Z,width:"1750",height:"1240"})),(0,a.kt)("p",null,"But the header shows we have the cache:"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"cached-redis-header.png",src:n(80100).Z,width:"1744",height:"902"})),(0,a.kt)("p",null,"We can also see that the response was ~200ms quicker!"),(0,a.kt)("p",null,"You can check out the Redis documentation ",(0,a.kt)("a",{parentName:"p",href:"https://redis.io/docs/"},"here")," and the\nRedis node package ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/redis/node-redis"},"here"),"."))}p.isMDXComponent=!0},28504:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/cached-redis-body-28873d1de299497a3b2ebc7112458e8e.png"},80100:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/cached-redis-header-c1e1f82d4797dbed7b0df541107be40e.png"},11874:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/uncached-redis-body-2c0927c35c634d44b937de9626abf533.png"},93274:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/uncached-redis-header-282d783adf41bd48a9ebb94aaeaf073b.png"}}]);