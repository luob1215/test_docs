"use strict";(self.webpackChunkdeno_docs=self.webpackChunkdeno_docs||[]).push([[5060],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>m});var s=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,s)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,s,a=function(e,t){if(null==e)return{};var n,s,a={},i=Object.keys(e);for(s=0;s<i.length;s++)n=i[s],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(s=0;s<i.length;s++)n=i[s],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=s.createContext({}),d=function(e){var t=s.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},u=function(e){var t=d(e.components);return s.createElement(l.Provider,{value:t},e.children)},p="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return s.createElement(s.Fragment,{},t)}},h=s.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,l=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),p=d(n),h=a,m=p["".concat(l,".").concat(h)]||p[h]||c[h]||i;return n?s.createElement(m,r(r({ref:t},u),{},{components:n})):s.createElement(m,r({ref:t},u))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,r=new Array(i);r[0]=h;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o[p]="string"==typeof e?e:a,r[1]=o;for(var d=2;d<i;d++)r[d]=n[d];return s.createElement.apply(null,r)}return s.createElement.apply(null,n)}h.displayName="MDXCreateElement"},35929:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>c,frontMatter:()=>i,metadata:()=>o,toc:()=>d});var s=n(87462),a=(n(67294),n(3905));const i={},r="Testing API",o={unversionedId:"manual/advanced/language_server/testing_api",id:"manual/advanced/language_server/testing_api",title:"Testing API",description:"The Deno language server supports a custom set of APIs to enable testing. These",source:"@site/runtime/manual/advanced/language_server/testing_api.md",sourceDirName:"manual/advanced/language_server",slug:"/manual/advanced/language_server/testing_api",permalink:"/runtime/manual/advanced/language_server/testing_api",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"runtimeGuideHome",previous:{title:"Import Completions and Intelligent Registries",permalink:"/runtime/manual/advanced/language_server/imports"},next:{title:"Contributing",permalink:"/runtime/manual/references/contributing/"}},l={},d=[{value:"Capabilities",id:"capabilities",level:2},{value:"Settings",id:"settings",level:2},{value:"Notifications",id:"notifications",level:2},{value:"<code>deno/testModule</code>",id:"denotestmodule",level:3},{value:"<code>deno/testModuleDelete</code>",id:"denotestmoduledelete",level:3},{value:"<code>deno/testRunProgress</code>",id:"denotestrunprogress",level:3},{value:"Requests",id:"requests",level:2},{value:"<code>deno/testRun</code>",id:"denotestrun",level:3},{value:"<code>deno/testRunCancel</code>",id:"denotestruncancel",level:3}],u={toc:d},p="wrapper";function c(e){let{components:t,...n}=e;return(0,a.kt)(p,(0,s.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"testing-api"},"Testing API"),(0,a.kt)("p",null,"The Deno language server supports a custom set of APIs to enable testing. These\nare built around providing information to enable the\n",(0,a.kt)("a",{parentName:"p",href:"https://code.visualstudio.com/api/extension-guides/testing"},"vscode's Testing API"),"\nbut can be used by other language server clients to provide a similar interface."),(0,a.kt)("h2",{id:"capabilities"},"Capabilities"),(0,a.kt)("p",null,"Both the client and the server should support the experimental ",(0,a.kt)("inlineCode",{parentName:"p"},"testingApi"),"\ncapability:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"interface ClientCapabilities {\n  experimental?: {\n    testingApi: boolean;\n  };\n}\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"interface ServerCapabilities {\n  experimental?: {\n    testingApi: boolean;\n  };\n}\n")),(0,a.kt)("p",null,"When a version of Deno that supports the testing API encounters a client which\nsupports the capability, it will initialize the code which handles the test\ndetection and will start providing the notifications which enable it."),(0,a.kt)("p",null,"It should also be noted that when the testing API capabilities are enabled, the\ntesting code lenses will no longer be sent to the client."),(0,a.kt)("h2",{id:"settings"},"Settings"),(0,a.kt)("p",null,"There are specific settings which change the behavior of the language server:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"deno.testing.args")," - An array of strings which will be provided as arguments\nwhen executing tests. This works in the same fashion as the ",(0,a.kt)("inlineCode",{parentName:"li"},"deno test"),"\nsubcommand."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"deno.testing.enable")," - A binary flag that enables or disables the testing\nserver")),(0,a.kt)("h2",{id:"notifications"},"Notifications"),(0,a.kt)("p",null,"The server will send notifications to the client under certain conditions."),(0,a.kt)("h3",{id:"denotestmodule"},(0,a.kt)("inlineCode",{parentName:"h3"},"deno/testModule")),(0,a.kt)("p",null,"When a module containing tests is discovered by the server, it will notify the\nclient by sending a ",(0,a.kt)("inlineCode",{parentName:"p"},"deno/testModule")," notification along with a payload of\n",(0,a.kt)("inlineCode",{parentName:"p"},"TestModuleParams"),"."),(0,a.kt)("p",null,"Deno structures in this fashion:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"A module can contain ",(0,a.kt)("em",{parentName:"li"},"n")," tests."),(0,a.kt)("li",{parentName:"ul"},"A test can contain ",(0,a.kt)("em",{parentName:"li"},"n")," steps."),(0,a.kt)("li",{parentName:"ul"},"A step can contain ",(0,a.kt)("em",{parentName:"li"},"n")," steps.")),(0,a.kt)("p",null,"When Deno does static analysis of a test module, it attempts to identify any\ntests and test steps. Because of the dynamic way tests can be declared in Deno,\nthey cannot always be statically identified and can only be identified when the\nmodule is executed. The notification is designed to handle both of these\nsituations when updating the client. When tests are discovered statically, the\nnotification ",(0,a.kt)("inlineCode",{parentName:"p"},"kind")," will be ",(0,a.kt)("inlineCode",{parentName:"p"},'"replace"'),", when tests or steps are discovered at\nexecution time, the notification ",(0,a.kt)("inlineCode",{parentName:"p"},"kind")," will be ",(0,a.kt)("inlineCode",{parentName:"p"},'"insert"'),"."),(0,a.kt)("p",null,"As a test document is edited in the editor, and ",(0,a.kt)("inlineCode",{parentName:"p"},"textDocument/didChange"),"\nnotifications are received from the client, the static analysis of those changes\nwill be performed server side and if the tests have changed, the client will\nreceive a notification."),(0,a.kt)("p",null,"When a client receives a ",(0,a.kt)("inlineCode",{parentName:"p"},'"replace"'),' notification, it can safely "replace" a\ntest module representation, where when an ',(0,a.kt)("inlineCode",{parentName:"p"},'"insert"')," it received, it should\nrecursively try to add to existing representations."),(0,a.kt)("p",null,"For test modules the ",(0,a.kt)("inlineCode",{parentName:"p"},"textDocument.uri")," should be used as the unique ID for any\nrepresentation (as it the string URL to the unique module). ",(0,a.kt)("inlineCode",{parentName:"p"},"TestData")," items\ncontain a unique ",(0,a.kt)("inlineCode",{parentName:"p"},"id")," string. This ",(0,a.kt)("inlineCode",{parentName:"p"},"id")," string is a SHA-256 hash of identifying\ninformation that the server tracks for a test."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts,",metastring:"ignore",ignore:!0},'interface TestData {\n  /** The unique ID for this test/step. */\n  id: string;\n\n  /** The display label for the test/step. */\n  label: string;\n\n  /** Any test steps that are associated with this test/step */\n  steps?: TestData[];\n\n  /** The range of the owning text document that applies to the test. */\n  range?: Range;\n}\n\ninterface TestModuleParams {\n  /** The text document identifier that the tests are related to. */\n  textDocument: TextDocumentIdentifier;\n\n  /** A indication if tests described are _newly_ discovered and should be\n   * _inserted_ or if the tests associated are a replacement for any existing\n   * tests. */\n  kind: "insert" | "replace";\n\n  /** The text label for the test module. */\n  label: string;\n\n  /** An array of tests that are owned by this test module. */\n  tests: TestData[];\n}\n')),(0,a.kt)("h3",{id:"denotestmoduledelete"},(0,a.kt)("inlineCode",{parentName:"h3"},"deno/testModuleDelete")),(0,a.kt)("p",null,"When a test module is deleted that the server is observing, the server will\nissue a ",(0,a.kt)("inlineCode",{parentName:"p"},"deno/testModuleDelete")," notification. When receiving the notification\nthe client should remove the representation of the test module and all of its\nchildren tests and test steps."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts,",metastring:"ignore",ignore:!0},"interface TestModuleDeleteParams {\n  /** The text document identifier that has been removed. */\n  textDocument: TextDocumentIdentifier;\n}\n")),(0,a.kt)("h3",{id:"denotestrunprogress"},(0,a.kt)("inlineCode",{parentName:"h3"},"deno/testRunProgress")),(0,a.kt)("p",null,"When a ",(0,a.kt)("a",{parentName:"p",href:"#denotestrun"},(0,a.kt)("inlineCode",{parentName:"a"},"deno/testRun"))," is requested from the client, the server\nwill support progress of that test run via the ",(0,a.kt)("inlineCode",{parentName:"p"},"deno/testRunProgress"),"\nnotification."),(0,a.kt)("p",null,"The client should process these messages and update any UI representation."),(0,a.kt)("p",null,"The state change is represented in the ",(0,a.kt)("inlineCode",{parentName:"p"},".message.kind")," property of the\n",(0,a.kt)("inlineCode",{parentName:"p"},"TestRunProgressParams"),". The states are:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},'"enqueued"')," - A test or test step has been enqueued for testing."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},'"skipped"')," - A test or test step was skipped. This occurs when the Deno test\nhas the ",(0,a.kt)("inlineCode",{parentName:"li"},"ignore")," option set to ",(0,a.kt)("inlineCode",{parentName:"li"},"true"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},'"started"')," - A test or test step has started."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},'"passed"')," - A test or test step has passed."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},'"failed"')," - A test or test step has failed. This is intended to indicate an\nerror with the test harness instead of the test itself, but Deno currently\ndoes not support this distinction."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},'"errored"')," - The test or test step has errored. Additional information about\nthe error will be in the ",(0,a.kt)("inlineCode",{parentName:"li"},".message.messages")," property."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},'"end"')," - The test run has ended.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts,",metastring:"ignore",ignore:!0},'interface TestIdentifier {\n  /** The test module the message is related to. */\n  textDocument: TextDocumentIdentifier;\n\n  /** The optional ID of the test. If not present, then the message applies to\n   * all tests in the test module. */\n  id?: string;\n\n  /** The optional ID of the step. If not present, then the message only applies\n   * to the test. */\n  stepId?: string;\n}\n\ninterface TestMessage {\n  /** The content of the message. */\n  message: MarkupContent;\n\n  /** An optional string which represents the expected output. */\n  expectedOutput?: string;\n\n  /** An optional string which represents the actual output. */\n  actualOutput?: string;\n\n  /** An optional location related to the message. */\n  location?: Location;\n}\n\ninterface TestEnqueuedStartedSkipped {\n  /** The state change that has occurred to a specific test or test step.\n   *\n   * - `"enqueued"` - the test is now enqueued to be tested\n   * - `"started"` - the test has started\n   * - `"skipped"` - the test was skipped\n   */\n  type: "enqueued" | "started" | "skipped";\n\n  /** The test or test step relating to the state change. */\n  test: TestIdentifier;\n}\n\ninterface TestFailedErrored {\n  /** The state change that has occurred to a specific test or test step.\n   *\n   * - `"failed"` - The test failed to run properly, versus the test erroring.\n   *   currently the Deno language server does not support this.\n   * - `"errored"` - The test errored.\n   */\n  type: "failed" | "errored";\n\n  /** The test or test step relating to the state change. */\n  test: TestIdentifier;\n\n  /** Messages related to the state change. */\n  messages: TestMessage[];\n\n  /** An optional duration, in milliseconds from the start to the current\n   * state. */\n  duration?: number;\n}\n\ninterface TestPassed {\n  /** The state change that has occurred to a specific test or test step. */\n  type: "passed";\n\n  /** The test or test step relating to the state change. */\n  test: TestIdentifier;\n\n  /** An optional duration, in milliseconds from the start to the current\n   * state. */\n  duration?: number;\n}\n\ninterface TestOutput {\n  /** The test or test step has output information / logged information. */\n  type: "output";\n\n  /** The value of the output. */\n  value: string;\n\n  /** The associated test or test step if there was one. */\n  test?: TestIdentifier;\n\n  /** An optional location associated with the output. */\n  location?: Location;\n}\n\ninterface TestEnd {\n  /** The test run has ended. */\n  type: "end";\n}\n\ntype TestRunProgressMessage =\n  | TestEnqueuedStartedSkipped\n  | TestFailedErrored\n  | TestPassed\n  | TestOutput\n  | TestEnd;\n\ninterface TestRunProgressParams {\n  /** The test run ID that the progress message applies to. */\n  id: number;\n\n  /** The message*/\n  message: TestRunProgressMessage;\n}\n')),(0,a.kt)("h2",{id:"requests"},"Requests"),(0,a.kt)("p",null,"The server handles two different requests:"),(0,a.kt)("h3",{id:"denotestrun"},(0,a.kt)("inlineCode",{parentName:"h3"},"deno/testRun")),(0,a.kt)("p",null,"To request the language server to perform a set of tests, the client sends a\n",(0,a.kt)("inlineCode",{parentName:"p"},"deno/testRun")," request, which includes that ID of the test run to be used in\nfuture responses to the client, the type of the test run, and any test modules\nor tests to include or exclude."),(0,a.kt)("p",null,"Currently Deno only supports the ",(0,a.kt)("inlineCode",{parentName:"p"},'"run"')," kind of test run. Both ",(0,a.kt)("inlineCode",{parentName:"p"},'"debug"')," and\n",(0,a.kt)("inlineCode",{parentName:"p"},'"coverage"')," are planned to be supported in the future."),(0,a.kt)("p",null,"When there are no test modules or tests that are included, it implies that all\ndiscovered tests modules and tests should be executed. When a test module is\nincluded, but not any test ids, it implies that all tests within that test\nmodule should be included. Once all the tests are identified, any excluded tests\nare removed and the resolved set of tests are returned in the response as\n",(0,a.kt)("inlineCode",{parentName:"p"},'"enqueued"'),"."),(0,a.kt)("p",null,"It is not possible to include or exclude test steps via this API, because of the\ndynamic nature of how test steps are declared and run."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts,",metastring:"ignore",ignore:!0},'interface TestRunRequestParams {\n  /** The id of the test run to be used for future messages. */\n  id: number;\n\n  /** The run kind. Currently Deno only supports `"run"` */\n  kind: "run" | "coverage" | "debug";\n\n  /** Test modules or tests to exclude from the test run. */\n  exclude?: TestIdentifier[];\n\n  /** Test modules or tests to include in the test run. */\n  include?: TestIdentifier[];\n}\n\ninterface EnqueuedTestModule {\n  /** The test module the enqueued test IDs relate to */\n  textDocument: TextDocumentIdentifier;\n\n  /** The test IDs which are now enqueued for testing */\n  ids: string[];\n}\n\ninterface TestRunResponseParams {\n  /** Test modules and test IDs that are now enqueued for testing. */\n  enqueued: EnqueuedTestModule[];\n}\n')),(0,a.kt)("h3",{id:"denotestruncancel"},(0,a.kt)("inlineCode",{parentName:"h3"},"deno/testRunCancel")),(0,a.kt)("p",null,"If a client wishes to cancel a currently running test run, it sends a\n",(0,a.kt)("inlineCode",{parentName:"p"},"deno/testRunCancel")," request with the test ID to cancel. The response back will\nbe a boolean of ",(0,a.kt)("inlineCode",{parentName:"p"},"true")," if the test is cancelled or ",(0,a.kt)("inlineCode",{parentName:"p"},"false")," if it was not\npossible. Appropriate test progress notifications will still be sent as the test\nis being cancelled."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"interface TestRunCancelParams {\n  /** The test id to be cancelled. */\n  id: number;\n}\n")))}c.isMDXComponent=!0}}]);